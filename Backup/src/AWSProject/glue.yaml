AWSTemplateFormatVersion: 2010-09-09

Resources:

  LambdaRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
          - Effect: Allow
            Principal:
              Service: quicksight.amazonaws.com
            Action:
              - 'sts:AssumeRole'
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Policies:
        - PolicyName: AdministratorAccess
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'
  
  # CustomFunction:
  #   Type: AWS::Lambda::Function
  #   Properties:
  #     Handler: index.lambda_handler
  #     Description: "GetTime"
  #     Timeout: 1
  #     Role: !GetAtt LambdaRole.Arn
  #     Runtime: python3.9
  #     Code:
  #       ZipFile: |
  #         import json
  #         import cfnresponse

  #         def lambda_handler(event, context):
  #           now = datetime.now()
  #           time = now.strftime("/%m/%d/")
  #           responseData[Data] = time
  #           cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)
  
  # CustomResource:
  #   Type: Custom::Value
  #   Properties:
  #     ServiceToken: !GetAtt CustomFunction.Arn
  #     Time: !Ref CustomFunction

  GlueRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'


  GlueDatabase:
    Type: AWS::Glue::Database
    Properties: 
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Join [ '', [ 'database-' , !Ref 'AWS::AccountId'] ]

  CostGlueDatabase:
    Type: AWS::Glue::Database
    Properties: 
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Join [ '', [ 'cost-database-' , !Ref 'AWS::AccountId'] ]

  # GlueClassifier:
  #   Type: 'AWS::Glue::Classifier'
  #   Properties:
  #     CsvClassifier:
  #       AllowSingleColumn: true
  #       ContainsHeader: PRESENT
  #       Delimiter: ','
  #       Header:
  #         - arnresource
  #         - resoucetype
  #         - backupsize
  #         - department
  #         - environment
  #       Name: csvclassify
  #       QuoteSymbol: '"'


  # CostGlueClassifier:
  #   Type: 'AWS::Glue::Classifier'
  #   Properties:
  #     CsvClassifier:
  #       AllowSingleColumn: true
  #       ContainsHeader: PRESENT
  #       Delimiter: ','
  #       Header:
  #         - start
  #         - end
  #         - tags
  #         - cost
  #       Name: costcsvclassify
  #       QuoteSymbol: '"'

  # GlueCrawler:
  #     Type: AWS::Glue::Crawler
  #     Properties:
  #       Name: !Join [ '', [ 'crawler-' , !Ref 'AWS::AccountId'] ]
  #       Role: !GetAtt 
  #       - GlueRole
  #       - Arn
  #       DatabaseName: !Ref GlueDatabase
  #       Classifiers:
  #       - !Ref GlueClassifier
  #       Targets:
  #         S3Targets:
  #           - Path: !Join [ '', [ 'new-backup-report-based-arn-tags-' , !Ref 'AWS::AccountId'] ]
  #       SchemaChangePolicy:
  #         UpdateBehavior: 'UPDATE_IN_DATABASE'
  #         DeleteBehavior: 'LOG'
  #       Schedule:
  #         ScheduleExpression: 'cron(00 00 * * ? *)'
  #       Configuration: "{\"Version\":1.0,\"Grouping\":{\"TableLevelConfiguration\":3}}"

  # CostGlueCrawler:
  #     Type: AWS::Glue::Crawler
  #     Properties:
  #       Name: !Join [ '', [ 'cost-crawler-' , !Ref 'AWS::AccountId'] ]
  #       Role: !GetAtt 
  #       - GlueRole
  #       - Arn
  #       DatabaseName: !Ref CostGlueDatabase
  #       Classifiers:
  #       - !Ref CostGlueClassifier
  #       Targets:
  #         S3Targets:
  #           - Path: !Join [ '', [ 'cost-report-for-quicksight-' , !Ref 'AWS::AccountId'] ]
  #       SchemaChangePolicy:
  #         UpdateBehavior: 'UPDATE_IN_DATABASE'
  #         DeleteBehavior: 'LOG'
  #       Schedule:
  #         ScheduleExpression: 'cron(00 00 * * ? *)'
  #       Configuration: "{\"Version\":1.0,\"Grouping\":{\"TableLevelConfiguration\":3}}"



  CostGlueTable:
    Type: 'AWS::Glue::Table'
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseName: !Ref CostGlueDatabase
      TableInput:
        Name: cost_report
        TableType: EXTERNAL_TABLE
        Parameters:
          classification: csv
          typeOfData: file
        StorageDescriptor:
          # Location: !Join [ '', [ 's3://cost-report-for-quicksight-' , !Ref 'AWS::AccountId', !GetAtt CustomResource.Time] ]
          Location: !Join [ '', [ 's3://cost-report-for-quicksight-' , !Ref 'AWS::AccountId', '/07/20/'] ]
          BucketColumns: []
          Columns:
            - Name: start
              Type: date
            - Name: end
              Type: date
            - Name: tags
              Type: string
            - Name: unblendedcost
              Type: float
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              case.insensitive: 'true'
              field.delim: ','
              skip.header.line.count: '1'
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  GlueTable:
    Type: 'AWS::Glue::Table'
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: backup_report
        TableType: EXTERNAL_TABLE
        Parameters:
          classification: csv
          typeOfData: file
        StorageDescriptor:
          Location: !Join [ '', [ 's3://new-backup-report-based-arn-tags-' , !Ref 'AWS::AccountId', '/07/20/'] ]
          BucketColumns: []
          Columns:
            - Name: resourcearn
              Type: string
            - Name: resourcetype
              Type: string
            - Name: backupsize
              Type: decimal
            - Name: department
              Type: string
            - Name: environment
              Type: string
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              case.insensitive: 'true'
              field.delim: ','
              skip.header.line.count: '1'
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
  